# HSQ Forms API - Azure DevOps Pipeline (Development)
# Pipeline för att bygga, testa och deploya HSQ Forms API på Azure App Service
# Denna pipeline är för utvecklingsmiljön
# Uppdaterad och validerad: 2025-08-09

trigger:
  branches:
    include:
      - develop
  paths:
    include:
      - src/**
      - infra/**
      - main.py
      - requirements.txt
      - alembic/**
      - azure-pipelines-dev.yml
      - forms/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Environment settings
  environment: 'dev'
  projectName: 'hsq-forms'
  location: 'westeurope'
  pythonVersion: '3.11'
  subscriptionId: 'c0b03b12-570f-4442-b337-c9175ad4037f'
  resourceGroupName: 'rg-hsq-forms-dev'
  appServiceSku: 'B1'

stages:
- stage: Test
  displayName: 'Test Application'
  jobs:
  - job: TestCode
    displayName: 'Run Tests'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
      displayName: 'Install dependencies'

    - script: |
        echo "Running tests..."
        python -m pytest tests/ -v --tb=native -k "not test_live_azure_storage_connection and not test_live_database_connection" --ignore=tests/test_webhooks.py
      displayName: 'Run tests'
      continueOnError: true

- stage: Deploy
  displayName: 'Deploy API'
  dependsOn: Test
  jobs:
  - job: DeployToAzure
    displayName: 'Deploy to Azure'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
        addToPath: true
      displayName: 'Use Python $(pythonVersion)'

    - script: |
        echo "Deploying to Azure App Service"
      displayName: 'Mock deployment'
