# ğŸš€ HSQ Forms API â€“ Azure Deployment GuideSenast uppdaterad: 2025-06-05## ğŸ“‹ Ã–versiktDenna guide visar hur du deployar HSQ Forms API till Azure med modern Azure Developer CLI (azd) workflow:- **Azure Container Apps** - fÃ¶r API hosting med autoscaling- **Azure Database for PostgreSQL Flexible Server** - fÃ¶r databas- **Azure Blob Storage** - fÃ¶r filuppladdningar med Managed Identity sÃ¤kerhet- **Azure Container Registry** - fÃ¶r Docker images- **Azure Log Analytics** - fÃ¶r monitorering och logging## ğŸ—ï¸ Arkitektur```â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                    Azure Resource Group                         â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚  â”‚   Container     â”‚  â”‚   PostgreSQL     â”‚  â”‚   Storage       â”‚ â”‚â”‚  â”‚     Apps        â”‚  â”‚   Flexible       â”‚  â”‚   Account       â”‚ â”‚â”‚  â”‚   Environment   â”‚  â”‚     Server       â”‚  â”‚                 â”‚ â”‚â”‚  â”‚                 â”‚  â”‚                  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  Database:       â”‚  â”‚  â”‚ Blob      â”‚  â”‚ â”‚â”‚  â”‚  â”‚ HSQ Forms â”‚â—„â”€â”¼â”€â”€â”¼â”€â–º hsq_forms     â”‚  â”‚  â”‚ Container â”‚  â”‚ â”‚â”‚  â”‚  â”‚    API    â”‚  â”‚  â”‚                  â”‚  â”‚  â”‚ uploads   â”‚  â”‚ â”‚â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚â”‚  â”‚        â”‚        â”‚  â”‚                  â”‚  â”‚                 â”‚ â”‚â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”‚  â”‚                  â”‚  â”‚  Managed        â”‚ â”‚â”‚  â”‚  â”‚ Managed   â”‚  â”‚  â”‚                  â”‚  â”‚  Identity       â”‚ â”‚â”‚  â”‚  â”‚ Identity  â”‚â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â–ºAuthentication â”‚ â”‚â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                  â”‚  â”‚                 â”‚ â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜```## ğŸ› ï¸ FÃ¶rutsÃ¤ttningarInnan du bÃ¶rjar, se till att du har:1. **Azure CLI** installerat och inloggat2. **Azure Developer CLI (azd)** installerat3. **Docker** installerat och igÃ¥ng4. **Git** fÃ¶r versionshantering```bash# Installera Azure Developer CLIcurl -fsSL https://aka.ms/install-azd.sh | bash# Logga inazd auth login```## ğŸš€ Deployment med Azure Developer CLI (rekommenderat)### Steg 1: FÃ¶rbered miljÃ¶n```bash# Klona projektet om du inte redan har detgit clone https://github.com/your-org/hsq-forms-api.gitcd hsq-forms-api# Skapa en ny miljÃ¶ (eller anslut till en befintlig)azd env new hsq-forms-prod# alternativt: azd env refresh```### Steg 2: Konfigurera miljÃ¶variabler```bash# SÃ¤tt PostgreSQL admin-lÃ¶senord (kommer sparas sÃ¤kert i Azure Key Vault)azd env set POSTGRES_PASSWORD "YourSecurePassword123!"azd env set DBADMINUSERNAME "postgres"# Konfigurera CORS (fÃ¶r produktionsmiljÃ¶n)azd env set ALLOWED_ORIGINS "https://your-app.com,https://admin.your-app.com"```### Steg 3: Deploy all infrastruktur och kod```bash# KÃ¶r en fullstÃ¤ndig deploymentazd up```Detta kommando kommer att:1. Provsiona alla Azure-resurser enligt Bicep-templaten2. Bygga Docker-imagen fÃ¶r API:et3. Pusha imagen till Azure Container Registry4. Deploya API:et till Azure Container Apps5. Konfigurera alla nÃ¶dvÃ¤ndiga miljÃ¶variabler### Steg 4: Verifiera deployment```bash# Visa URL:er fÃ¶r deploymentazd env get-values# Testa API:etcurl $(azd env get-values | grep ENDPOINT_URL | cut -d= -f2)```## ğŸ“Š Monitorering och logs### Azure Container Apps logs```bash# Visa live logs fÃ¶r APIaz containerapp logs show \  --resource-group rg-hsq-forms-prod \  --name hsq-forms-api \  --follow```### Application InsightsApplikationen skickar telemetridata till Application Insights automatiskt. FÃ¶r att utforska denna data:1. GÃ¥ till Azure Portal2. Navigera till Application Insights-resursen i din resursgrupp3. Utforska logs, prestanda, och fel## ğŸ›¡ï¸ SÃ¤kerhetskonfiguration### Managed IdentityAPI:et anvÃ¤nder Managed Identity fÃ¶r att sÃ¤kert kommunicera med Azure Blob Storage. Inga lagrade nycklar behÃ¶vs.### PostgreSQL-sÃ¤kerhetFÃ¶r ytterligare sÃ¤kerhetskonfigurationer:```bash# Aktivera SSL fÃ¶r PostgreSQLaz postgres flexible-server parameter set \  --resource-group rg-hsq-forms-prod \  --server-name psql-hsq-forms-prod \  --name ssl_min_protocol_version \  --value TLSv1.2```## ğŸ”„ Kontinuerlig DeploymentFÃ¶r att konfigurera GitHub Actions fÃ¶r kontinuerlig deployment:1. KÃ¶r fÃ¶ljande kommando fÃ¶r att konfigurera CI/CD:   ```bash   azd pipeline config   ```2. FÃ¶lj instruktionerna fÃ¶r att koppla ditt GitHub-repo3. Skapa en service principal fÃ¶r GitHub Actions:   ```bash   az ad sp create-for-rbac --name "hsq-forms-api-github" --role contributor \     --scopes /subscriptions/{SubID}/resourceGroups/rg-hsq-forms-prod \     --sdk-auth   ```4. LÃ¤gg till fÃ¶ljande secrets i GitHub repo:   - AZURE_CREDENTIALS: Utdata frÃ¥n fÃ¶regÃ¥ende kommando   - AZURE_ENV_NAME: 'prod'## ğŸ“ FelsÃ¶kning### Problem med deployment```bash# Kontrollera loggar fÃ¶r Container App deploymentaz containerapp logs show \  --resource-group rg-hsq-forms-prod \  --name hsq-forms-api \  --tail 100# Kontrollera Container Registry problemaz acr build-task logs \  --registry $(az acr list --resource-group rg-hsq-forms-prod --query "[0].name" -o tsv) \  --build-id $(az acr task list-runs --registry $(az acr list --resource-group rg-hsq-forms-prod --query "[0].name" -o tsv) --query "[0].runId" -o tsv)```### Databasproblem```bash# Kontrollera PostgreSQL-loggaraz postgres flexible-server parameter set \  --resource-group rg-hsq-forms-prod \  --server-name psql-hsq-forms-prod \  --name log_statement \  --value all# Health Checkaz postgres flexible-server show \  --resource-group rg-hsq-forms-prod \  --name psql-hsq-forms-prod \  --query "state"```### Storage-problem```bash# Storage Health Checkaz storage account show \  --name $(az storage account list --resource-group rg-hsq-forms-prod --query "[0].name" -o tsv) \  --resource-group rg-hsq-forms-prod \  --query "provisioningState"```## ğŸ“‹ Checklista fÃ¶r deployment- [ ] Azure CLI och azd installerat- [ ] Logga in pÃ¥ Azure (`az login`, `azd auth login`)- [ ] Klona repo och gÃ¥ till projektmappen- [ ] Konfigurera environment variabler (`.env`)- [ ] KÃ¶r `azd up` fÃ¶r fÃ¶rsta deployment- [ ] Kontrollera att alla resurser skapats korrekt- [ ] Testa API endpoints- [ ] Konfigurera CI/CD pipeline (valfritt)- [ ] Konfigurera monitorering och alerting- [ ] Dokumentera deployment-specifika instÃ¤llningar## ğŸ¯ NÃ¤sta stegEfter framgÃ¥ngsrik deployment:1. **Konfigurera Custom Domain** (valfritt)2. **SÃ¤tt upp SSL/TLS certifikat**3. **Implementera backup-strategi fÃ¶r databas**4. **Konfigurera alerting och monitoring**5. **SÃ¤tt upp staging environment**6. **Implementera blue-green deployment**---## ğŸ“š Ytterligare resurser- [Azure Container Apps dokumentation](https://docs.microsoft.com/en-us/azure/container-apps/)- [Azure Developer CLI dokumentation](https://docs.microsoft.com/en-us/azure/developer/azure-developer-cli/)- [Azure PostgreSQL Flexible Server](https://docs.microsoft.com/en-us/azure/postgresql/flexible-server/)- [Azure Blob Storage med Managed Identity](https://docs.microsoft.com/en-us/azure/storage/blobs/storage-auth-aad-msi)**Senast uppdaterad:** 2025-06-05  **NÃ¤sta review:** 2026-06-05